# Self-Healing CI Workflow

## Overview
The project now includes an automated self-healing mechanism for CI failures. When any CI job fails, the workflow automatically creates a GitHub issue with detailed context and assigns it to GitHub Copilot for automated analysis and fixing.

## How It Works

### 1. Trigger Conditions
The `self_heal_trigger` job activates when:
- ‚úÖ Any CI job fails (commitlint, checks, unit-tests, e2e-tests, or build)
- ‚úÖ The event is a push to main (not pull requests)
- ‚ö†Ô∏è The workflow has proper permissions

### 2. Failure Detection
The workflow automatically detects which specific jobs failed and captures:
- Job names that failed
- Workflow run ID and URL
- Commit SHA and branch
- Actor who triggered the workflow
- Timestamp of failure

### 3. Issue Creation
Creates a detailed GitHub issue containing:

**Title Format:** `üî¥ CI Failure: <failed-jobs> (<short-sha>)`

**Issue Body Includes:**
- Summary of failed jobs
- Direct link to workflow logs
- Commit and branch information
- Recommended investigation steps
- Actionable next steps

**Labels Applied:**
- `ci-failure` - Identifies as CI failure
- `bug` - Marks as bug
- `automated` - Indicates auto-generated

**Auto-Assignment:**
- Issue mentions `@copilot` in the body
- Copilot receives notification to analyze and fix
- (Note: Direct assignment to copilot user is not supported)

### 4. Additional Context
A follow-up comment is added with:
- Environment details (OS, Node version)
- Investigation suggestions
- Local reproduction commands
- Direct request for Copilot to create a fix PR

## Permissions

The job uses minimal required permissions:
```yaml
permissions:
  contents: write      # To checkout code
  issues: write        # To create and assign issues
  pull-requests: write # For copilot to create fix PRs
```

## Example Issue

When CI fails, you'll see an issue like this:

````markdown
## üî¥ CI Failure Detected

**Action Required:** The CI workflow has failed and needs immediate attention.

### Failure Details
- **Failed Jobs:** checks, unit-tests
- **Workflow Run:** [View full logs](https://github.com/user/repo/actions/runs/123456)
- **Branch:** `main`
- **Commit:** `abc1234` by @username
- **Triggered:** Mon, 25 Nov 2024 20:00:00 GMT

### Error Context
The following job(s) failed in this CI run:
- **checks**
- **unit-tests**

Please review the [workflow logs](link) for detailed error messages and stack traces.

### Recommended Actions
1. **Review the error logs** in the workflow run linked above
2. **Identify the root cause** of the failure
3. **Create a fix** that resolves the issue
4. **Test locally** before submitting a PR
5. **Submit a pull request** with the fix

### Auto-Assignment
This issue has been automatically assigned to @copilot for analysis and automated fixing.

---
**ü§ñ Auto-generated by self-healing CI workflow**
*Workflow: CI | Run ID: 123456*
````

## Configuration

### Required Repository Secrets
No additional secrets needed beyond existing ones. The workflow uses:
- `GITHUB_TOKEN` (automatically provided)
- Existing repository secrets for CI jobs

### Enabling/Disabling
To disable self-healing temporarily, add to the `if` condition:
```yaml
if: ${{ failure() && github.event_name != 'pull_request' && vars.ENABLE_SELF_HEALING == 'true' }}
```

Then set the repository variable `ENABLE_SELF_HEALING` to `true`/`false`.

## Benefits

### 1. Automated Response
- ‚úÖ Immediate notification when CI breaks
- ‚úÖ No manual issue creation needed
- ‚úÖ Consistent issue format

### 2. Rich Context
- ‚úÖ All relevant information in one place
- ‚úÖ Direct links to logs
- ‚úÖ Reproduction steps provided

### 3. AI-Assisted Fixes
- ‚úÖ Copilot automatically assigned
- ‚úÖ Can create fix PRs autonomously
- ‚úÖ Reduces time to resolution

### 4. Audit Trail
- ‚úÖ All failures tracked as issues
- ‚úÖ Labels for easy filtering
- ‚úÖ Historical record of CI health

## Troubleshooting

### Issue: Self-healing job doesn't trigger
**Cause:** Permissions not set correctly
**Solution:** Ensure the workflow has `issues: write` permission

### Issue: Cannot assign to @copilot
**Cause:** Copilot not enabled for repository
**Solution:** Enable GitHub Copilot for your organization/repository

### Issue: Too many issues created
**Cause:** Frequent CI failures
**Solution:** 
1. Fix underlying CI issues first
2. Temporarily disable self-healing
3. Add rate limiting (can modify workflow to check recent issues)

## Example Workflow

1. Developer pushes code to main
2. CI runs and unit-tests fail
3. `self_heal_trigger` activates
4. Issue created: "üî¥ CI Failure: unit-tests (abc1234)"
5. Issue assigned to @copilot
6. Developer and team notified via GitHub
7. Copilot analyzes logs
8. Copilot creates fix PR
9. Team reviews and merges
10. CI passes ‚úÖ

## Metrics to Track

Monitor these to measure effectiveness:
- Time from CI failure to issue creation: ~30 seconds
- Time from issue to Copilot response: Varies
- Fix success rate: Track how many auto-fixes work
- False positive rate: Issues that didn't need fixes

## Future Enhancements

Potential improvements to consider:
- [ ] Add rate limiting to prevent spam
- [ ] Include diff of changes that broke CI
- [ ] Add automatic rollback for main branch
- [ ] Integrate with Slack/Discord notifications
- [ ] Add severity classification
- [ ] Track repeated failures of same type
- [ ] Auto-close issues when CI passes again

---

**Status:** ‚úÖ Active and monitoring
**Last Updated:** 2024-11-25
