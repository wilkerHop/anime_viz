name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Validate current commit (last commit)
        run: npx commitlint --from HEAD~1 --to HEAD --verbose

  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Check for Sins
        run: |
          if grep -rE "eslint-disable|@ts-ignore|@ts-nocheck|@ts-expect-error" src/; then
            echo "Found TypeScript sins! Please remove them."
            exit 1
          fi
      - name: Type Check
        run: npx tsc --noEmit

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: "file:./dev.db"
      - name: Unit Tests
        env:
          MAL_CLIENT_ID: "test-client-id"
        run: npm test

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: E2E Tests
        env:
          MAL_API_BASE: "http://localhost:4000"
          MAL_CLIENT_ID: "dummy"
          DATABASE_URL: "file:./dev.db"
        run: |
          npx ts-node e2e/mocks/server.ts &
          sleep 5
          npx prisma db push
          npx playwright test

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: "file:./dev.db"
      - name: Build
        run: npm run build
        env:
          DATABASE_URL: "file:./dev.db"
          MAL_CLIENT_ID: ${{ secrets.MAL_CLIENT_ID }}

  # ============================================================================
  # SELF-HEALING CI: Automatically creates issue and assigns to Copilot on failure
  # ============================================================================
  self_heal_trigger:
    name: Auto-Fix CI Failure
    runs-on: ubuntu-latest
    if: ${{ failure() && github.event_name != 'pull_request' }}
    needs: [commitlint, checks, unit-tests, e2e-tests, build]
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get failed job information
        id: failure-info
        run: |
          # Capture workflow run URL
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          
          # Determine which job(s) failed
          FAILED_JOBS=""
          if [ "${{ needs.commitlint.result }}" = "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}commitlint, "
          fi
          if [ "${{ needs.checks.result }}" = "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}checks, "
          fi
          if [ "${{ needs.unit-tests.result }}" = "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}unit-tests, "
          fi
          if [ "${{ needs.e2e-tests.result }}" = "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}e2e-tests, "
          fi
          if [ "${{ needs.build.result }}" = "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}build, "
          fi
          
          # Remove trailing comma and space
          FAILED_JOBS="${FAILED_JOBS%, }"
          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT
      
      - name: Create issue with failure context
        id: create-issue
        uses: actions/github-script@v7
        with:
         script: |
            const failedJobs = '${{ steps.failure-info.outputs.failed_jobs }}';
            const runUrl = '${{ steps.failure-info.outputs.run_url }}';
            const sha = '${{ github.sha }}';
            const shortSha = sha.substring(0, 7);
            const branch = '${{ github.ref_name }}';
            const actor = '${{ github.actor }}';
            
            const issueBody = [
              '## üî¥ CI Failure Detected',
              '',
              '**Action Required:** The CI workflow has failed and needs immediate attention.',
              '',
              '### Failure Details',
              `- **Failed Jobs:** ${failedJobs}`,
              `- **Workflow Run:** [View full logs](${runUrl})`,
              `- **Branch:** \`${branch}\``,
              `- **Commit:** \`${shortSha}\` by @${actor}`,
              `- **Triggered:** ${new Date().toUTCString()}`,
              '',
              '### Error Context',
              'The following job(s) failed in this CI run:',
              ...failedJobs.split(', ').map(job => `- **${job}**`),
              '',
              `Please review the [workflow logs](${runUrl}) for detailed error messages and stack traces.`,
              '',
              '### Recommended Actions',
              '1. **Review the error logs** in the workflow run linked above',
              '2. **Identify the root cause** of the failure',
              '3. **Create a fix** that resolves the issue',
              '4. **Test locally** before submitting a PR',
              '5. **Submit a pull request** with the fix',
              '',
              '### Auto-Assignment',
              'This issue has been automatically assigned to @copilot for analysis and automated fixing.',
              '',
              '---',
              '**ü§ñ Auto-generated by self-healing CI workflow**',
              `*Workflow: CI | Run ID: ${{ github.run_id }}*`
            ].join('\n');

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üî¥ CI Failure: ${failedJobs} (${shortSha})`,
              body: issueBody,
              labels: ['ci-failure', 'bug', 'automated'],
              assignees: ['copilot']
            });
            
            console.log(`Created issue #${issue.number}: ${issue.html_url}`);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_url', issue.html_url);
            return issue.number;
      
      - name: Add comment with additional context
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const failedJobs = '${{ steps.failure-info.outputs.failed_jobs }}';
            
            const commands = [];
            if (failedJobs.includes('commitlint')) commands.push('npx commitlint --from HEAD~1 --to HEAD --verbose');
            if (failedJobs.includes('checks')) commands.push('npm run lint && npx tsc --noEmit');
            if (failedJobs.includes('unit-tests')) commands.push('npm test');
            if (failedJobs.includes('e2e-tests')) commands.push('npx playwright test');
            if (failedJobs.includes('build')) commands.push('npm run build');
            
            const commentBody = [
              '### üìã Additional Debug Information',
              '',
              '**Environment:**',
              '- Runner OS: Ubuntu Latest',
              '- Node Version: 20',
              '- Event Type: ${{ github.event_name }}',
              '',
              '**Suggested Investigation Steps:**',
              '1. Check if recent dependency updates caused the failure',
              '2. Review recent code changes in commit ${{ github.sha }}',
              '3. Verify database migrations are up to date',
              '4. Check for environment-specific issues',
              '',
              '**Quick Commands for Local Reproduction:**',
              '```bash',
              '# Checkout the failing commit',
              'git checkout ${{ github.sha }}',
              '',
              '# Install dependencies',
              'npm ci',
              '',
              '# Run the failed job(s) locally',
              ...commands,
              '```',
              '',
              '@copilot Please analyze the failure logs and create a pull request with the fix.'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });
            
            console.log(`Added debug comment to issue #${issueNumber}`);
      
      - name: Report success
        run: |
          echo "‚úÖ Self-healing workflow triggered successfully"
          echo "üìù Issue #${{ steps.create-issue.outputs.result }} created"
          echo "üîó ${{ steps.create-issue.outputs.issue_url }}"
          echo "ü§ñ Assigned to @copilot for automated fixing"
